const { Client } = require('pg');
require('dotenv').config({ path: '.env.development' });
const fs = require('fs');
const path = require('path');
const bcrypt = require('bcrypt');

async function setupDatabase() {
  const client = new Client({
    host: process.env.DB_HOST || 'localhost',
    port: process.env.DB_PORT || 5432,
    user: process.env.DB_USERNAME || 'postgres',
    password: process.env.DB_PASSWORD || 'admin',
    database: 'postgres', // Connect to default database first
  });

  try {
    console.log('üîÑ Connecting to PostgreSQL...');
    await client.connect();
    
    console.log('üóÉÔ∏è Creating paykey database...');
    // Create database if it doesn't exist
    await client.query('CREATE DATABASE paykey');
    console.log('‚úÖ Database paykey created');
    
    // Close connection and reconnect to paykey database
    await client.end();
    
    const paykeyClient = new Client({
      host: process.env.DB_HOST || 'localhost',
      port: process.env.DB_PORT || 5432,
      user: process.env.DB_USERNAME || 'postgres',
      password: process.env.DB_PASSWORD || 'admin',
      database: 'paykey',
    });
    
    await paykeyClient.connect();
    console.log('üîó Connected to paykey database');
    
    // Step 1: Create schema using existing schema.sql
    console.log('üìã Creating database schema...');
    const schemaSQL = fs.readFileSync(path.join(__dirname, '../schema.sql'), 'utf8');
    await paykeyClient.query(schemaSQL);
    console.log('‚úÖ Schema created successfully');
    
    // Step 2: Create missing columns that TypeORM expects
    console.log('üîß Adding TypeORM missing columns...');
    const addColumnsSQL = `
      -- Add missing columns that TypeORM entity expects
      ALTER TABLE users 
      ADD COLUMN IF NOT EXISTS "residentStatus" VARCHAR,
      ADD COLUMN IF NOT EXISTS "countryCode" VARCHAR,
      ADD COLUMN IF NOT EXISTS "nationalityId" UUID,
      ADD COLUMN IF NOT EXISTS "idType" VARCHAR,
      ADD COLUMN IF NOT EXISTS "isOnboardingCompleted" BOOLEAN DEFAULT false;

      -- Create indexes
      CREATE INDEX IF NOT EXISTS idx_users_resident_status ON users("residentStatus");
      CREATE INDEX IF NOT EXISTS idx_users_country_code ON users("countryCode");
      CREATE INDEX IF NOT EXISTS idx_users_nationality_id ON users("nationalityId");
      CREATE INDEX IF NOT EXISTS idx_users_id_type ON users("idType");
      CREATE INDEX IF NOT EXISTS idx_users_onboarding_completed ON users("isOnboardingCompleted");
    `;
    
    await paykeyClient.query(addColumnsSQL);
    console.log('‚úÖ Missing columns added');
    
    // Step 3: Insert countries data
    console.log('üåç Seeding countries...');
    const countriesSQL = `
      INSERT INTO countries (code, name, currency, "isActive") VALUES
      ('KE', 'Kenya', 'KES', true),
      ('UG', 'Uganda', 'UGX', true),
      ('TZ', 'Tanzania', 'TZS', true),
      ('RW', 'Rwanda', 'RWF', true),
      ('US', 'United States', 'USD', true),
      ('GB', 'United Kingdom', 'GBP', true)
      ON CONFLICT (code) DO NOTHING;
    `;
    await paykeyClient.query(countriesSQL);
    console.log('‚úÖ Countries seeded');
    
    // Step 4: Create demo user
    console.log('üë§ Creating demo user...');
    const hashedPassword = await bcrypt.hash('testuser123', 10);
    
    const demoUserSQL = `
      INSERT INTO users (
        email, 
        "passwordHash", 
        role, 
        "firstName", 
        "lastName", 
        tier,
        "countryCode",
        "isOnboardingCompleted",
        "residentStatus"
      ) VALUES (
        'testuser@paykey.com',
        $1,
        'USER',
        'Demo',
        'User',
        'FREE',
        'KE',
        true,
        'RESIDENT'
      ) ON CONFLICT (email) DO NOTHING;
    `;
    
    await paykeyClient.query(demoUserSQL, [hashedPassword]);
    console.log('‚úÖ Demo user created');
    
    // Step 5: Insert sample tax table data
    console.log('üí∞ Creating tax configuration...');
    const taxTableSQL = `
      INSERT INTO tax_tables (
        year, 
        "effectiveDate", 
        "nssfConfig", 
        "nhifConfig", 
        "housingLevyRate", 
        "payeBands", 
        "personalRelief", 
        "isActive"
      ) VALUES (
        2024,
        '2024-01-01',
        '{"employeeRate": 0.06, "employerRate": 0.12, "maxAmount": 10800}',
        '{"minAmount": 6000, "rate": 0.0175, "maxAmount": 18000}',
        0.015,
        '[
          {"min": 0, "max": 24000, "rate": 0.1},
          {"min": 24001, "max": 32333, "rate": 0.15},
          {"min": 32334, "max": 500000, "rate": 0.2},
          {"min": 500001, "max": 800000, "rate": 0.25}
        ]',
        2400,
        true
      ) ON CONFLICT DO NOTHING;
    `;
    
    await paykeyClient.query(taxTableSQL);
    console.log('‚úÖ Tax configuration created');
    
    // Step 6: Verify setup
    console.log('\nüìã Verifying database setup...');
    const userResult = await paykeyClient.query('SELECT email, role, tier FROM users WHERE email = $1', ['testuser@paykey.com']);
    const countryResult = await paykeyClient.query('SELECT COUNT(*) as count FROM countries');
    const taxResult = await paykeyClient.query('SELECT COUNT(*) as count FROM tax_tables WHERE "isActive" = true');
    
    console.log(`üë§ Demo user: ${userResult.rows[0]?.email || 'Not found'}`);
    console.log(`üåç Countries: ${countryResult.rows[0]?.count} entries`);
    console.log(`üí∞ Active tax tables: ${taxResult.rows[0]?.count} entries`);
    
    console.log('\nüéâ Database setup completed successfully!');
    console.log('\nüìù Test Credentials:');
    console.log('   Email: testuser@paykey.com');
    console.log('   Password: testuser123');
    
  } catch (error) {
    console.error('‚ùå Setup failed:', error.message);
  } finally {
    await client.end();
    process.exit(0);
  }
}

setupDatabase();