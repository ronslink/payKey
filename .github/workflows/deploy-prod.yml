name: Deploy PROD (All Services)

on:
  workflow_dispatch:

jobs:
  deploy-all:
    name: Deploy Entire Stack
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: PROD

    steps:
      - name: Deploy to DigitalOcean
        uses: appleboy/ssh-action@v1.0.0
        env:
          DO_HOST: ${{ secrets.DO_HOST }}
          DO_USERNAME: ${{ secrets.DO_USERNAME }}
          DO_SSH_KEY: ${{ secrets.DO_SSH_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          INTASEND_PUBLISHABLE_KEY: ${{ secrets.INTASEND_PUB_KEY_PROD }}
          INTASEND_SECRET: ${{ secrets.INTASEND_SECRET_KEY_PROD }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          INTASEND_WEBHOOK_SECRET: ${{ secrets.INTASEND_WEBHOOK_SECRET }}
          CR_PAT: ${{ secrets.CR_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          APPLE_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_BUNDLE_ID: ${{ secrets.APPLE_BUNDLE_ID }}
          APPLE_PRIVATE_KEY: ${{ secrets.APPLE_PRIVATE_KEY }}
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          envs: DO_HOST, DO_USERNAME, DO_SSH_KEY, DATABASE_URL, JWT_SECRET, INTASEND_PUBLISHABLE_KEY, INTASEND_SECRET, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, INTASEND_WEBHOOK_SECRET, GITHUB_TOKEN, APPLE_KEY_ID, APPLE_TEAM_ID, APPLE_BUNDLE_ID, APPLE_PRIVATE_KEY, GOOGLE_CLIENT_ID
          script: |
            cd /opt/paykey
            
            # =============================================
            # CLEANUP PHASE - Force remove everything first
            # =============================================
            
            echo "ğŸ§¹ Force removing containers that may be blocking..."
            docker rm -f paykey_backend_prod 2>/dev/null || true
            docker rm -f paykey_redis_prod 2>/dev/null || true
            docker rm -f paykey_website_prod 2>/dev/null || true
            docker rm -f paydome_website_prod 2>/dev/null || true
            
            echo "ğŸ§¹ Stopping all compose services..."
            docker compose --env-file .env -f deploy/docker-compose.backend.yml down 2>/dev/null || true
            docker compose --env-file .env -f deploy/docker-compose.website.yml down 2>/dev/null || true
            docker compose --env-file .env -f deploy/docker-compose.website.yml -f docker-compose.prod.yml down 2>/dev/null || true
            docker compose --env-file .env -f deploy/docker-compose.infra.yml down 2>/dev/null || true
            
            echo "ğŸŒ Removing Docker network..."
            docker network rm paykey-network-prod 2>/dev/null || true
            
            # 0. Authenticate with Registry using GITHUB_TOKEN
            echo $GITHUB_TOKEN | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            echo "ğŸš€ Starting Full Production Deployment..."
            
            # 1. Update Codebase
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main

            # 2. Generate .env file from Secrets (Using Managed Database)
            echo "ğŸ” Generating secure .env file..."
            cat <<EOF | sed 's/^[ \t]*//' | tr -d '\r' > .env
            NODE_ENV=production
            DATABASE_URL=$DATABASE_URL
            REDIS_HOST=paykey_redis_prod
            REDIS_PORT=6379
            JWT_SECRET=$JWT_SECRET
            JWT_EXPIRES_IN=7d
            INTASEND_PUBLISHABLE_KEY=$INTASEND_PUBLISHABLE_KEY
            INTASEND_SECRET_KEY=$INTASEND_SECRET
            INTASEND_IS_LIVE=true
            STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY
            STRIPE_WEBHOOK_SECRET=$STRIPE_WEBHOOK_SECRET
            INTASEND_WEBHOOK_SECRET=$INTASEND_WEBHOOK_SECRET
            GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
            APPLE_KEY_ID=$APPLE_KEY_ID
            APPLE_TEAM_ID=$APPLE_TEAM_ID
            APPLE_BUNDLE_ID=$APPLE_BUNDLE_ID
            APPLE_PRIVATE_KEY="$APPLE_PRIVATE_KEY"
            NODE_EXTRA_CA_CERTS=/app/ca-certificate.crt
            EOF
            
            # 3. Load Environment Variables for Docker Compose Substitution
            set -a
            source .env
            set +a

            # =============================================
            # DEPLOY PHASE - Create network and bring up services
            # =============================================
            
            echo "ğŸŒ Creating Docker network..."
            docker network create paykey-network-prod 2>/dev/null || true
            
            # 4. Deploy Infrastructure (DB, Redis, Network)
            echo "ğŸ“¦ Deploying Infrastructure..."
            docker compose --env-file .env -f deploy/docker-compose.infra.yml up -d --remove-orphans

            # 4. Deploy Backend
            echo "ğŸ”™ Deploying Backend..."
            docker compose --env-file .env -f deploy/docker-compose.backend.yml pull backend
            docker compose --env-file .env -f deploy/docker-compose.backend.yml up -d backend --remove-orphans --force-recreate
            
            echo "ğŸ“Š Checking container status..."
            docker ps -a --filter name=paykey_backend_prod
            
            echo "ğŸ“œ Recent Logs:"
            docker logs --tail 50 paykey_backend_prod
            
            # 5. Deploy Website
            echo "ğŸŒ Deploying Website..."
            docker compose --env-file .env -f deploy/docker-compose.website.yml pull website
            docker compose --env-file .env -f deploy/docker-compose.website.yml up -d website

            # 6. Cleanup
            docker image prune -f
            echo "âœ… Full Deployment Complete: $(date)"

