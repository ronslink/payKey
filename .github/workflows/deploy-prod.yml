name: Deploy PROD (All Services)

on:
  workflow_dispatch:

jobs:
  deploy-all:
    name: Deploy Entire Stack
    runs-on: ubuntu-latest
    environment: PROD

    steps:
      - name: Deploy to DigitalOcean
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          envs: DO_HOST, DO_USERNAME, DO_SSH_KEY, DATABASE_URL, JWT_SECRET, INTASEND_PUBLISHABLE_KEY, INTASEND_SECRET, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, CR_PAT
          script: |
            cd /opt/paykey
            
            # 0. Authenticate with Registry
            echo $CR_PAT | docker login ghcr.io -u ronslink --password-stdin

            echo "üöÄ Starting Full Production Deployment..."
            
            # 1. Update Codebase
            git pull origin main

            # 2. Generate .env file from Secrets (Using Managed Database)
            echo "üîê Generating secure .env file..."
            cat <<EOF > .env
            NODE_ENV=production
            DATABASE_URL=$DATABASE_URL
            REDIS_HOST=redis
            REDIS_PORT=6379
            JWT_SECRET=$JWT_SECRET
            JWT_EXPIRES_IN=7d
            INTASEND_PUBLISHABLE_KEY=$INTASEND_PUBLISHABLE_KEY
            INTASEND_SECRET_KEY=$INTASEND_SECRET
            INTASEND_IS_LIVE=true
            STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY
            STRIPE_WEBHOOK_SECRET=$STRIPE_WEBHOOK_SECRET
            NODE_EXTRA_CA_CERTS=/app/ca-certificate.crt
            EOF
            
            # 3. Load Environment Variables for Docker Compose Substitution
            set -a
            source .env
            set +a

            # 3. Deploy Infrastructure (DB, Redis, Network)
            echo "üì¶ Deploying Infrastructure..."
            docker-compose -f deploy/docker-compose.infra.yml up -d

            # 4. Deploy Backend
            echo "üîô Deploying Backend..."
            docker-compose -f deploy/docker-compose.backend.yml pull backend
            docker-compose -f deploy/docker-compose.backend.yml up -d backend
            
            # 5. Deploy Website
            echo "üåê Deploying Website..."
            docker-compose -f deploy/docker-compose.website.yml pull website
            docker-compose -f deploy/docker-compose.website.yml up -d website

            # 6. Cleanup
            docker image prune -f
            echo "‚úÖ Full Deployment Complete: $(date)"
