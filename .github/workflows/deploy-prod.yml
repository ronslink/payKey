name: Deploy PROD (All Services)

on:
  workflow_dispatch:

jobs:
  deploy-all:
    name: Deploy Entire Stack
    runs-on: ubuntu-latest
    environment: PROD

    steps:
      - name: Deploy to DigitalOcean
        uses: appleboy/ssh-action@v1.0.0
        env:
          DO_HOST: ${{ secrets.DO_HOST }}
          DO_USERNAME: ${{ secrets.DO_USERNAME }}
          DO_SSH_KEY: ${{ secrets.DO_SSH_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          INTASEND_PUBLISHABLE_KEY: ${{ secrets.INTASEND_PUBLISHABLE_KEY }}
          INTASEND_SECRET: ${{ secrets.INTASEND_SECRET }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          INTASEND_WEBHOOK_SECRET: ${{ secrets.INTASEND_WEBHOOK_SECRET }}
          CR_PAT: ${{ secrets.CR_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          APPLE_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_BUNDLE_ID: ${{ secrets.APPLE_BUNDLE_ID }}
          APPLE_PRIVATE_KEY: ${{ secrets.APPLE_PRIVATE_KEY }}
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          envs: DO_HOST, DO_USERNAME, DO_SSH_KEY, DATABASE_URL, JWT_SECRET, INTASEND_PUBLISHABLE_KEY, INTASEND_SECRET, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, INTASEND_WEBHOOK_SECRET, GITHUB_TOKEN, APPLE_KEY_ID, APPLE_TEAM_ID, APPLE_BUNDLE_ID, APPLE_PRIVATE_KEY, GOOGLE_CLIENT_ID
          script: |
            cd /opt/paykey
            
            # 0. Authenticate with Registry using GITHUB_TOKEN
            echo $GITHUB_TOKEN | docker login ghcr.io -u ${{ github.actor }} --password-stdin


            echo "üöÄ Starting Full Production Deployment..."
            
            echo "üì• Stashing local changes..."
            git stash || true
            
            # 1. Update Codebase
            git pull origin main

            # 2. Generate .env file from Secrets (Using Managed Database)
            echo "üîê Generating secure .env file..."
            cat <<EOF > .env
            NODE_ENV=production
            DATABASE_URL=$DATABASE_URL
            REDIS_HOST=paykey_redis_prod
            REDIS_PORT=6379
            JWT_SECRET=$JWT_SECRET
            JWT_EXPIRES_IN=7d
            INTASEND_PUBLISHABLE_KEY=$INTASEND_PUBLISHABLE_KEY
            INTASEND_SECRET_KEY=$INTASEND_SECRET
            INTASEND_IS_LIVE=true
            STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY
            STRIPE_WEBHOOK_SECRET=$STRIPE_WEBHOOK_SECRET
            INTASEND_WEBHOOK_SECRET=$INTASEND_WEBHOOK_SECRET
            GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
            APPLE_KEY_ID=$APPLE_KEY_ID
            APPLE_TEAM_ID=$APPLE_TEAM_ID
            APPLE_BUNDLE_ID=$APPLE_BUNDLE_ID
            APPLE_PRIVATE_KEY="$APPLE_PRIVATE_KEY"
            NODE_EXTRA_CA_CERTS=/app/ca-certificate.crt
            EOF
            
            # 3. Load Environment Variables for Docker Compose Substitution
            set -a
            source .env
            set +a

            # 3. Load Environment Variables explicitly
            # We created .env in the root (/opt/paykey)
            # Docker Compose needs to know where it is.
            
            # 3. Deploy Infrastructure (DB, Redis, Network)
            echo "üì¶ Deploying Infrastructure..."
            # Remove potential conflicting containers first if needed, though 'up' usually handles it.
            # But since we saw a conflict error, forced removal might be safer for a clean state.
            # docker stop paykey_redis_prod || true
            # docker rm paykey_redis_prod || true
            
            docker compose --env-file .env -f deploy/docker-compose.infra.yml up -d --remove-orphans

            # 4. Deploy Backend
            echo "üîô Deploying Backend..."
            docker compose --env-file .env -f deploy/docker-compose.backend.yml pull backend
            docker compose --env-file .env -f deploy/docker-compose.backend.yml up -d backend --remove-orphans
            
            # 5. Deploy Website
            echo "üåê Deploying Website..."
            docker compose --env-file .env -f deploy/docker-compose.website.yml pull website
            docker compose --env-file .env -f deploy/docker-compose.website.yml up -d website

            # 6. Seed Tax Configurations
            echo "üßæ Seeding Tax Configurations..."
            # Wait a few seconds for backend to be ready
            sleep 10
            docker exec paykey_backend_prod node dist/scripts/seed-tax-configs-2025.js || echo "‚ö†Ô∏è Seeding failed, but continuing deployment..."

            # 7. Cleanup
            docker image prune -f
            echo "‚úÖ Full Deployment Complete: $(date)"

