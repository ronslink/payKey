# Backend service for production (uses managed DigitalOcean PostgreSQL)
# Usage: docker-compose -f deploy/docker-compose.backend.yml up -d

services:
  backend:
    image: ghcr.io/ronslink/paykey-backend:latest
    container_name: paykey_backend_prod
    restart: always
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_HOST=paykey_redis_prod
      - REDIS_PORT=6379
      - REDIS_PASSWORD=PayKeyRedisSecure2025!
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      - INTASEND_PUBLISHABLE_KEY=${INTASEND_PUBLISHABLE_KEY}
      - INTASEND_SECRET_KEY=${INTASEND_SECRET_KEY}
      - INTASEND_IS_LIVE=true
      - INTASEND_CHALLENGE=${INTASEND_CHALLENGE}
      - INTASEND_WEBHOOK_SECRET=${INTASEND_WEBHOOK_SECRET}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - APPLE_KEY_ID=${APPLE_KEY_ID}
      - APPLE_TEAM_ID=${APPLE_TEAM_ID}
      - APPLE_BUNDLE_ID=${APPLE_BUNDLE_ID}
      - NODE_EXTRA_CA_CERTS=/app/ca-certificate.crt
    volumes:
      - /opt/paykey/ca-certificate.crt:/app/ca-certificate.crt:ro
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - paykey-network-prod
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://127.0.0.1:3000/api" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  paykey-network-prod:
    external: true
